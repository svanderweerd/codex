<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-8.5.10"><title>SQLAlchemy - Codex</title><link rel=stylesheet href=../../../../assets/stylesheets/main.472b142f.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.08040f6c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../css/timeago.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#core-concepts class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=Codex class="md-header__button md-logo" aria-label=Codex data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Codex </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> SQLAlchemy </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=Codex class="md-nav__button md-logo" aria-label=Codex data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Codex </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Arts <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Arts data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Arts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../arts/setup-mkdocs/ class=md-nav__link> Setup Mkdocs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Health <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Health data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Health </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../health/sleep/ class=md-nav__link> Sleep </a> </li> <li class=md-nav__item> <a href=../../../../health/fitness/ class=md-nav__link> Fitness </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <div class="md-nav__link md-nav__link--index "> <a href=../../../../devops/ >DevOps</a> <label for=__nav_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=DevOps data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> DevOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/bash/ class=md-nav__link> Bash </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Setup mkdocs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Setup mkdocs" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Setup mkdocs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../devops/setup-docs/getting-started.md class=md-nav__link> Getting started </a> </li> <li class=md-nav__item> <a href=../../../../devops/setup-docs/tools-plugins.md class=md-nav__link> Tools & plugins </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> Coding <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Coding data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_1 type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1> Architecture <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Architecture data-md-level=2> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../architecture/repository-pattern/ class=md-nav__link> Repository pattern </a> </li> <li class=md-nav__item> <a href=../../../architecture/ddd/ class=md-nav__link> Domain Driven Design </a> </li> <li class=md-nav__item> <a href=../../../architecture/entity-relationship/ class=md-nav__link> Entity relationship modelling </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../intellij-idea/ class=md-nav__link> Intellij IDEA </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_3 type=checkbox id=__nav_5_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../ >Python</a> <label for=__nav_5_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Python data-md-level=2> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5_3_1 type=checkbox id=__nav_5_3_1 checked> <label class=md-nav__link for=__nav_5_3_1> Libraries <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Libraries data-md-level=3> <label class=md-nav__title for=__nav_5_3_1> <span class="md-nav__icon md-icon"></span> Libraries </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> SQLAlchemy <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> SQLAlchemy </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#core-concepts class=md-nav__link> Core concepts </a> <nav class=md-nav aria-label="Core concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#declarative-mapping class=md-nav__link> Declarative mapping </a> </li> <li class=md-nav__item> <a href=#the-engine class=md-nav__link> The engine </a> </li> <li class=md-nav__item> <a href=#session class=md-nav__link> Session </a> </li> <li class=md-nav__item> <a href=#models-ie-tables class=md-nav__link> Models (i.e. tables) </a> </li> <li class=md-nav__item> <a href=#storing-data-using-models-sessions class=md-nav__link> Storing data using Models &amp; Sessions </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#entity-relationships-in-sqlalchemy class=md-nav__link> Entity relationships in SQLAlchemy </a> <nav class=md-nav aria-label="Entity relationships in SQLAlchemy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#one-to-many class=md-nav__link> One-to-many </a> </li> <li class=md-nav__item> <a href=#back-references class=md-nav__link> Back references </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#code-example-working-with-our-models-sa class=md-nav__link> Code example - working with our models &amp; SA </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../pydantic/ class=md-nav__link> Pydantic </a> </li> <li class=md-nav__item> <a href=../alembic/ class=md-nav__link> Alembic </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../data-structures/ class=md-nav__link> Data structures </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#core-concepts class=md-nav__link> Core concepts </a> <nav class=md-nav aria-label="Core concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#declarative-mapping class=md-nav__link> Declarative mapping </a> </li> <li class=md-nav__item> <a href=#the-engine class=md-nav__link> The engine </a> </li> <li class=md-nav__item> <a href=#session class=md-nav__link> Session </a> </li> <li class=md-nav__item> <a href=#models-ie-tables class=md-nav__link> Models (i.e. tables) </a> </li> <li class=md-nav__item> <a href=#storing-data-using-models-sessions class=md-nav__link> Storing data using Models &amp; Sessions </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#entity-relationships-in-sqlalchemy class=md-nav__link> Entity relationships in SQLAlchemy </a> <nav class=md-nav aria-label="Entity relationships in SQLAlchemy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#one-to-many class=md-nav__link> One-to-many </a> </li> <li class=md-nav__item> <a href=#back-references class=md-nav__link> Back references </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#code-example-working-with-our-models-sa class=md-nav__link> Code example - working with our models &amp; SA </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <span class=md-tag>db</span> </nav> <h1>SQLAlchemy</h1> <p><a href=https://docs.sqlalchemy.org/en/14/ >SQLAlchemy</a> is an ORM built with Domain Driven Design in mind <a href=https://techspot.zzzeek.org/2012/02/07/patterns-implemented-by-sqlalchemy/ >post</a>. It can be used to perform ad hoc querying on your database (db), but also used as an ORM for larger applications. SA has 2 components: <strong>Core</strong> and <strong>ORM</strong>.</p> <h2 id=core-concepts>Core concepts<a class=headerlink href=#core-concepts title="Permanent link">&para;</a></h2> <h3 id=declarative-mapping>Declarative mapping<a class=headerlink href=#declarative-mapping title="Permanent link">&para;</a></h3> <p>We want to define tables and columns from our Python classes using the ORM. In SQLAlchemy, this is enabled through a <a href=https://docs.sqlalchemy.org/en/14/orm/mapping_styles.html#orm-declarative-mapping>declarative mapping</a>. The most common pattern is constructing a base class using the SQLALchemy <code>declarative_base</code> function, and then having all DB model classes inherit from this base class.</p> <p>To enable us to create tables and columns from our data classes, we need to construct a mapping between a class (i.e., Model) and the table (and it's columns). Below features a declarative base which is then used in a declarative table mapping:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span> <span class=n>ForeignKey</span>
<span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>declarative_base</span>

<span class=c1># declarative base class</span>
<span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</code></pre></div> <p>Above, we instantiate a base class with the return object provided by the <code>declarative_base</code> callable. We can then use this Base class when constructing our Models (i.e., tables):</p> <div class=highlight><pre><span></span><code><span class=c1># an example mapping using the base class</span>
<span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;user&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>)</span>
    <span class=n>fullname</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>)</span>
    <span class=n>nickname</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>)</span>
</code></pre></div> <p>You can use a decorator as well (also provided by SA). This enables you to declare helper methods on the <code>Base</code> class, like automatically creating a <code>__tablename__</code>. Using a decorator will look like the following:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>as_declarative</span>

<span class=nd>@as_declarative</span><span class=p>()</span>
<span class=k>class</span> <span class=nc>Base</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
    <span class=nd>@declared_attr</span>
    <span class=k>def</span> <span class=nf>__tablename__</span><span class=p>(</span><span class=bp>cls</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=vm>__name__</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <p>The decorator form of mapping is particularly useful when combining a SQLAlchemy declarative mapping with other forms of class declaration, notably the Python <code>dataclasses</code> module or Pydantic.</p> <h3 id=the-engine>The engine<a class=headerlink href=#the-engine title="Permanent link">&para;</a></h3> <p>The start of any SQLAlchemy application is an object called the <a href=https://docs.sqlalchemy.org/en/14/core/future.html#sqlalchemy.future.Engine><code>Engine</code></a>. This object acts as a central source of connections to a particular database, providing both a factory and a holding space called a <a href=https://docs.sqlalchemy.org/en/14/core/pooling.html>connection pool</a> for these database connections. The engine is typically a global object created just once for a particular database server.</p> <p>The <code>Engine</code> is created by using <code>create_engine()</code> (see the SA <a href=https://docs.sqlalchemy.org/en/14/core/engines.html#sqlalchemy.create_engine>docs</a> as well); we also set the flag <code>future</code> to <code>True</code>, since we want to make use of SA's new API version:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span>

<span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s2>&quot;sqlite+pysqlite:///:memory:&quot;</span><span class=p>,</span> <span class=n>echo</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <p>The main argument to <code>create_engine()</code> is our DB connection URI, which tells the engine what kind of db we have and where the db is located.</p> <h3 id=session>Session<a class=headerlink href=#session title="Permanent link">&para;</a></h3> <p>Interacting directly with the engine might be okay for simple tasks, but when you are building a bigger application it might be better to start with the ORM from the get-go. By using the ORM, you basically abstract away the SQL stuff. You interact with the db using <code>Model</code> objects, i.e. data classes. In this case, Models represent your db's tables, the attributes of Models represent the table's columns.</p> <p>A Session is a persistent database connection that makes it easier to communicate with our database. The session begins in a mostly stateless form; once the session object is called, it requests a connection resource from the <code>engine</code> that it is <em>bound</em> to.</p> <p><a href=https://docs.sqlalchemy.org/en/14/orm/session_api.html#sqlalchemy.orm.Session>Sessions</a> are created by binding them to an SQLAlchemy engine, which we covered in the previous part. With an engine created, all we need is to use SQLAlchemy's <code>sessionmaker</code> to define a session and bind it to our engine:</p> <div class=highlight><pre><span></span><code><span class=sd>&quot;&quot;&quot;database.py&quot;&quot;&quot;</span>
<span class=sd>&quot;&quot;&quot;Database engine &amp; session creation.&quot;&quot;&quot;</span>
<span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span>  <span class=c1># noqa</span>
<span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>  <span class=c1># noqa</span>

<span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span>
    <span class=s1>&#39;mysql+pymysql://user:password@host:3600/database&#39;</span><span class=p>,</span>
    <span class=n>echo</span><span class=o>=</span><span class=kc>True</span>
<span class=p>)</span>
<span class=n>Session</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
<span class=n>session</span> <span class=o>=</span> <span class=n>Session</span><span class=p>()</span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>On sessionmaker</p> <p>Session is a regular Python class which can be directly instantiated. However, to standardize how sessions are configured and acquired,the <a href=https://docs.sqlalchemy.org/en/14/orm/session_api.html#sqlalchemy.orm.sessionmaker><code>sessionmaker</code></a> class is normally used to create a top level <code>Session</code> configuration which can then be used throughout an application without the need to repeat the configuration arguments.</p> </div> <h3 id=models-ie-tables>Models (i.e. tables)<a class=headerlink href=#models-ie-tables title="Permanent link">&para;</a></h3> <p>The <code>User</code> class example that is shown below, is a <code>Model</code> that is used to represent a <code>users</code> table in our database. You can see that we have imported several SQLAlchemy <em>types</em>, which we see getting passed into each <code>Column</code>. Each type corresponds to a SQL data type. Thus, our SQL table columns' data types would be <code>integer</code>, <code>varchar(255)</code>, and <code>text</code>, respectively. Columns can also accept optional parameters to things like keys or column constraints:</p> <ul> <li>primary_key: Designates a column as the table's "primary key," a highly recommended practice that serves as a unique identifier as well as an index for SQL to search on.</li> <li>autoincrement: Only relevant to columns that are both the <code>primary_key</code> and have the type <code>Integer</code>. Each user we create will automatically be assigned an <code>id</code>, where our first user will have an id of 1, and subsequent users would increment accordingly.</li> <li>unique: Places a constraint where no two records/rows share the same value for the given column (we don't want two users to have the same username).</li> <li>nullable: When set to <code>True</code>, adds a constraint that the column is mandatory, and no row will be created unless a value is provided.</li> <li>key: Places a secondary <code>key</code> on the given column, typically used in tandem with another constraint such as <code>index</code>.</li> <li>index: Designates that a column's values are sortable in a non-arbitrary way in the interest of improving query performance.</li> <li>server_default: A default value to assign if a value is not explicitly passed.</li> </ul> <div class="admonition tip"> <p class=admonition-title>Models &amp; Schemas</p> <p>When building Python api/crud apps, we often use both SQLAlchemy &amp; <a href=../pydantic/ >Pydantic</a>. Both packages use the concept of <code>Models</code> when referring to their data classes. To differentiate between them, I'll refer to my Pydanctic Models as <strong>schemas</strong> and my sqlalchemy models as <strong>models</strong>.</p> </div> <p>When you create an instance of a model (e.g., you create a user), you are effectively creating a new row in the associated db table. But before you can do that, you first need to make sure that you have a table already. Now, you can either create that by (i) accessing your database and create a table manually, (ii) use SA's built-in method on your Base class that creates the tables for you (see code sample below); or (iii) make use of migration tool such as <a href=../alembic/ >Alembic</a>.</p> <div class=highlight><pre><span></span><code><span class=c1># continues from above</span>
<span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=n>engine</span><span class=p>)</span>
</code></pre></div> <h3 id=storing-data-using-models-sessions>Storing data using Models &amp; Sessions<a class=headerlink href=#storing-data-using-models-sessions title="Permanent link">&para;</a></h3> <p>With a model defined and session created, we have the luxury of adding and modifying data purely in Python. SQLAlchemy refers to this as <em>function-based query construction</em>. To create a record in our <code>users</code> db table, we need to create an instance of our <code>User</code> model, and use our <code>session</code> to pass our instance to the engine:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>models</span> <span class=kn>import</span> <span class=n>User</span>  <span class=c1># noqa</span>
<span class=kn>from</span> <span class=nn>database</span> <span class=kn>import</span> <span class=n>session</span>  <span class=c1># noqa</span>

<span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span>
    <span class=n>username</span><span class=o>=</span><span class=s2>&quot;Bob-12&quot;</span><span class=p>,</span>
    <span class=n>password</span><span class=o>=</span><span class=s2>&quot;Please don&#39;t set passwords like this&quot;</span><span class=p>,</span>
    <span class=n>email</span><span class=o>=</span><span class=s2>&quot;Bob12@example.com&quot;</span><span class=p>,</span>
<span class=p>)</span>

<span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>  <span class=c1># add the user</span>
<span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>  <span class=c1># commit the change</span>
</code></pre></div> <p>With an instance of <code>User</code> created, all it takes to create this user in our database are two calls to our session: <code>add()</code> queues the item for creation, and <code>commit()</code> saves the change. We should now see a row in our database's user table!</p> <p>Working with session is as easy as four simple methods:</p> <ul> <li><code>session.add()</code>: We can pass an instance of a data model into add() to quickly create a new record to be added to our database.</li> <li><code>session.delete()</code>: Like the above, delete() accepts an instance of a data model. If that record exists in our database, it will be staged for deletion.</li> <li><code>session.commit()</code>: Changes made within a session are not saved until explicitly committed.</li> <li><code>session.close()</code>: Unlike SQLAlchemy engines, sessions are connections that remain open until explicitly closed.</li> </ul> <h2 id=entity-relationships-in-sqlalchemy>Entity relationships in SQLAlchemy<a class=headerlink href=#entity-relationships-in-sqlalchemy title="Permanent link">&para;</a></h2> <p>SA provides several features that allow you to define <a href=../../../architecture/entity-relationship/ >entity relations</a> in your app's data model. To understand <a href=https://docs.sqlalchemy.org/en/14/orm/relationships.html>relationships in SA</a>, imagine that we build an app for blogging where we need three models:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>declarative_base</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>Text</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>,</span> <span class=n>Boolean</span>  <span class=c1># noqa</span>
<span class=kn>from</span> <span class=nn>sqlalchemy.sql</span> <span class=kn>import</span> <span class=n>func</span>  <span class=c1># noqa</span>


<span class=k>class</span> <span class=nc>User</span><span class=p>():</span>
    <span class=sd>&quot;&quot;&quot;User account.&quot;&quot;&quot;</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;user&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>autoincrement</span><span class=o>=</span><span class=s2>&quot;auto&quot;</span><span class=p>)</span>
    <span class=n>username</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Text</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>email</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>Comment</span><span class=p>():</span>
    <span class=sd>&quot;&quot;&quot;User-generated comment on a blog post.&quot;&quot;&quot;</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;comment&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>user_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
    <span class=n>post_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>body</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Text</span><span class=p>)</span>
    <span class=n>upvotes</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
    <span class=n>removed</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Boolean</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>created_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>())</span>


<span class=k>class</span> <span class=nc>Post</span><span class=p>():</span>
    <span class=sd>&quot;&quot;&quot;Blog post.&quot;&quot;&quot;</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;post&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>author_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
    <span class=n>slug</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>title</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>summary</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>400</span><span class=p>))</span>
    <span class=n>feature_image</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>300</span><span class=p>))</span>
    <span class=n>body</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Text</span><span class=p>)</span>
    <span class=n>status</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&quot;unpublished&quot;</span><span class=p>)</span>
    <span class=n>created_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>())</span>
    <span class=n>updated_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>())</span>
</code></pre></div> <h3 id=one-to-many>One-to-many<a class=headerlink href=#one-to-many title="Permanent link">&para;</a></h3> <p>We use the <code>relationship</code> function to provide a relationship between two mapped classes. Consider it some kind of "magic" attribute that will contain the values from other tables related to this one. We update our <code>Post</code> and <code>Comment</code> Models to implement the relationship accordingly:</p> <div class=highlight><pre><span></span><code><span class=o>...</span>


<span class=k>class</span> <span class=nc>Comment</span><span class=p>():</span>
    <span class=sd>&quot;&quot;&quot;User-generated comment on a blog post.&quot;&quot;&quot;</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;comment&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>user_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s2>&quot;user.id&quot;</span><span class=p>))</span>  <span class=c1># ---- (1.i) ----</span>
    <span class=n>post_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s2>&quot;post.id&quot;</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># ---- (1.ii) ----</span>
    <span class=n>body</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Text</span><span class=p>)</span>
    <span class=n>upvotes</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
    <span class=n>removed</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Boolean</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>created_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>())</span>

    <span class=c1># Relationships</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&quot;User&quot;</span><span class=p>)</span>  <span class=c1># ---- (2.i) ----</span>


<span class=k>class</span> <span class=nc>Post</span><span class=p>():</span>
    <span class=sd>&quot;&quot;&quot;Blog post.&quot;&quot;&quot;</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;post&quot;</span>

    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>author_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s2>&quot;user.id&quot;</span><span class=p>))</span>  <span class=c1># ---- (1.iii) ----</span>
    <span class=n>slug</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>title</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=n>summary</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>400</span><span class=p>))</span>
    <span class=n>body</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Text</span><span class=p>)</span>
    <span class=n>status</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&quot;unpublished&quot;</span><span class=p>)</span>
    <span class=n>created_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>())</span>
    <span class=n>updated_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>())</span>

    <span class=c1># Relationships</span>
    <span class=n>author</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&quot;User&quot;</span><span class=p>)</span>  <span class=c1># ---- (2.ii) ----</span>
    <span class=n>comments</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&quot;Comment&quot;</span><span class=p>)</span>  <span class=c1># ---- (2.iii) ----</span>
</code></pre></div> <p>As shown above, we have added several one-to-many relationships using the (1) <code>ForeignKey</code> and (2) <code>relationship()</code> concepts:</p> <ol> <li>We've set some attributes (i.e., columns) as Foreign Keys with <code>ForeignKey</code> property.We basically tie data between our tables so that fetching one will allow us to get information about the other.<ol> <li>Our <code>comment</code> table has a foreign key <code>user.id</code> linked to its <code>user_id</code> attribute, indicating that the commenter has a record in the <code>user</code> table.</li> <li>This table also has a foreign key <code>post.id</code> linked to its <code>post_id</code> attribute, indicating that a comment should have a relation to an existing post in the <code>post</code> table.</li> <li>Lastly, we note that our <code>post</code> table has a foreign key <code>user.id</code> linked to its <code>author_id</code> attribute, indicating a relation with the <code>user</code> table.</li> </ol> </li> <li>The other new concept here is relationships. Relationships complement foreign keys and are a way of telling our application (not our database) that we're building relationships between two <code>Models</code> (instead of db tables!).<ol> <li>In our <code>Comment</code> Model we define a relationship with the <code>User</code> model and assign it to <code>user</code>.</li> <li>Similarly, in our <code>Post</code> Model we define a relationship between our <code>author</code> attribute and the <code>User</code> Model, and</li> <li>We define a relationship between our <code>comments</code> atttribute and the <code>Comment</code> Model.</li> </ol> </li> </ol> <div class="admonition info"> <p class=admonition-title>On FKs and relationships()</p> <p>Foreign keys tell our <em>database</em> which relationships we're building, and relationships tell our <em>app</em> which relationships we're building.</p> </div> <p>The point of all this is the ability to easily perform JOINs in our app. When using an ORM, we wouldn't be able to say "join this <code>Model</code> with that <code>Model</code>", because our app would have no idea which columns (Model attributes) to join on. When our relationships are specified in our Models, we can do things like join two tables together without specifying any further detail: SQLAlchemy will know how to join tables/models by looking at what we set in our data models (through foreign keys &amp; relationships).</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>SQLAlchemy only creates tables from data models if the tables don't already exist. In other words, if we have faulty relationships the first time we run our app, the error messages will persist the second time we run our app, even if we think we've fixed the problem. To deal with strange error messages, try deleting your SQL tables before running your app again whenever making changes to a model.</p> </div> <h3 id=back-references>Back references<a class=headerlink href=#back-references title="Permanent link">&para;</a></h3> <p>Specifying relationships on a data model allows us to access properties of the linked model via a property on the original model. If we were to join our <code>Comment</code> model with our <code>User</code> model, we'd be able to access the properties of a comment's author via <code>Comment.user.username</code>, where <code>user</code> is the name of our relationship, and <code>username</code> is a property of the associated model (the <code>User</code> model in this case).</p> <p>Relationships created in this way are one-directional, in that the <code>Comment</code> model can access the <code>User</code> props through its <code>user</code> prop, but the <code>User</code> model can't access the props of the <code>Comment</code> model. SA provides the <code>backref</code> param to enable just that, making it a bidirectional relationship. Let's update our <code>Post</code> Model:</p> <div class=highlight><pre><span></span><code><span class=n>author</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&quot;User&quot;</span><span class=p>,</span> <span class=n>backref</span><span class=o>=</span><span class=s2>&quot;posts&quot;</span><span class=p>)</span>
</code></pre></div> <p>We can now access user details of a post by calling <code>Post.author</code>. Go to the section</p> <h2 id=code-example-working-with-our-models-sa>Code example - working with our models &amp; SA<a class=headerlink href=#code-example-working-with-our-models-sa title="Permanent link">&para;</a></h2> <p>We are fist going to instantiate 1 <code>User</code> and 2 <code>Post</code> objects:</p> <div class=highlight><pre><span></span><code><span class=c1># objects.py</span>

<span class=n>admin_user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span>
    <span class=n>username</span><span class=o>=</span><span class=s2>&quot;Bob-12&quot;</span><span class=p>,</span>
    <span class=n>password</span><span class=o>=</span><span class=s2>&quot;Please don&#39;t set passwords like this&quot;</span><span class=p>,</span>
    <span class=n>email</span><span class=o>=</span><span class=s2>&quot;Bob12@example.com&quot;</span><span class=p>,</span>
<span class=p>)</span>

<span class=n>post_1</span> <span class=o>=</span> <span class=n>Post</span><span class=p>(</span>
    <span class=n>author_id</span> <span class=o>=</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
    <span class=n>slug</span> <span class=o>=</span> <span class=s2>&quot;fake-post-slug&quot;</span><span class=p>,</span>
    <span class=n>title</span> <span class=o>=</span> <span class=s2>&quot;fake title&quot;</span><span class=p>,</span>
    <span class=n>summary</span> <span class=o>=</span> <span class=s2>&quot;a post example&quot;</span><span class=p>,</span>
    <span class=n>body</span> <span class=o>=</span> <span class=s2>&quot;lorem ipsum blabla. This contains the actual text of the post&quot;</span><span class=p>,</span>
    <span class=n>status</span> <span class=o>=</span> <span class=s2>&quot;published&quot;</span>
<span class=p>)</span>

<span class=n>post_2</span> <span class=o>=</span> <span class=n>Post</span><span class=p>(</span>
    <span class=n>author_id</span><span class=o>=</span><span class=n>admin_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
    <span class=n>slug</span><span class=o>=</span><span class=s2>&quot;an-additional-post&quot;</span><span class=p>,</span>
    <span class=n>title</span><span class=o>=</span><span class=s2>&quot;Yet Another Post Title&quot;</span><span class=p>,</span>
    <span class=n>summary</span><span class=o>=</span><span class=s2>&quot;An in-depth exploration into writing your second blog post.&quot;</span><span class=p>,</span>
    <span class=n>body</span><span class=o>=</span><span class=s2>&quot;Smelly cheese cheese slices fromage&quot;</span><span class=p>,</span>
    <span class=n>status</span><span class=o>=</span><span class=s2>&quot;published&quot;</span><span class=p>,</span>
<span class=p>)</span>
</code></pre></div> <p>Now we want to create functions that allow us to save our objects to the database:</p> <div class=highlight><pre><span></span><code><span class=c1># orm.py</span>

<span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Create a new user if username isn&#39;t already taken.</span>

<span class=sd>    :param session: SQLAlchemy database session.</span>
<span class=sd>    :type session: Session</span>
<span class=sd>    :param user: New user record to create.</span>
<span class=sd>    :type user: User</span>

<span class=sd>    :return: Optional[User]</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>existing_user</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>username</span> <span class=o>==</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>existing_user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>  <span class=c1># Add the user</span>
            <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>  <span class=c1># Commit the change</span>
            <span class=n>LOGGER</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Created user: </span><span class=si>{</span><span class=n>user</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>LOGGER</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Users already exists in database: </span><span class=si>{</span><span class=n>existing_user</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>username</span> <span class=o>==</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
    <span class=k>except</span> <span class=n>IntegrityError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=n>LOGGER</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>orig</span><span class=p>)</span>
        <span class=k>raise</span> <span class=n>e</span><span class=o>.</span><span class=n>orig</span>
    <span class=k>except</span> <span class=n>SQLAlchemyError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=n>LOGGER</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Unexpected error when creating user: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=k>raise</span> <span class=n>e</span>


<span class=k>def</span> <span class=nf>create_post</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>post</span><span class=p>:</span> <span class=n>Post</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Post</span><span class=p>:</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Create a post.</span>

<span class=sd>    :param session: SQLAlchemy database session.</span>
<span class=sd>    :type session: Session</span>
<span class=sd>    :param post: Blog post to be created.</span>
<span class=sd>    :type post: Post</span>

<span class=sd>    :return: Post</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>existing_post</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Post</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>Post</span><span class=o>.</span><span class=n>slug</span> <span class=o>==</span> <span class=n>post</span><span class=o>.</span><span class=n>slug</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>existing_post</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>post</span><span class=p>)</span>  <span class=c1># Add the post</span>
            <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>  <span class=c1># Commit the change</span>
            <span class=n>LOGGER</span><span class=o>.</span><span class=n>success</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;Created post </span><span class=si>{</span><span class=n>post</span><span class=si>}</span><span class=s2> published by user </span><span class=si>{</span><span class=n>post</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Post</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>Post</span><span class=o>.</span><span class=n>slug</span> <span class=o>==</span> <span class=n>post</span><span class=o>.</span><span class=n>slug</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>LOGGER</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Post already exists in database: </span><span class=si>{</span><span class=n>post</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>existing_post</span>
    <span class=k>except</span> <span class=n>IntegrityError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=n>LOGGER</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>orig</span><span class=p>)</span>
        <span class=k>raise</span> <span class=n>e</span><span class=o>.</span><span class=n>orig</span>
    <span class=k>except</span> <span class=n>SQLAlchemyError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=n>LOGGER</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Unexpected error when creating user: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=k>raise</span> <span class=n>e</span>
</code></pre></div> <p>First we pass our objects to the crud functions to store them in our db, and subsequently we define a function that allows us to retrieve the data from our db.</p> <div class=highlight><pre><span></span><code><span class=c1># objects.py</span>
<span class=o>...</span>
<span class=n>admin_user</span> <span class=o>=</span> <span class=n>create_user</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>)</span>
<span class=n>post_1</span> <span class=o>=</span> <span class=n>create_post</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>post_1</span><span class=p>)</span>
<span class=n>post_2</span> <span class=o>=</span> <span class=n>create_post</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>post_2</span><span class=p>)</span>

<span class=c1># orm.py</span>
<span class=o>...</span>
<span class=k>def</span> <span class=nf>get_all_posts</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Fetch all posts belonging to an author user.</span>

<span class=sd>    :param session: SQLAlchemy database session.</span>
<span class=sd>    :type session: Session</span>
<span class=sd>    :param admin_user: Author of blog posts.</span>
<span class=sd>    :type admin_user: User</span>

<span class=sd>    :return: None</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>posts</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Post</span><span class=p>)</span>  <span class=c1># (1)</span>
        <span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>Post</span><span class=o>.</span><span class=n>author_id</span> <span class=o>==</span> <span class=n>User</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>  <span class=c1># (2)</span>
        <span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>admin_user</span><span class=o>.</span><span class=n>username</span><span class=p>)</span>  <span class=c1># (3)</span>
        <span class=o>.</span><span class=n>all</span><span class=p>()</span>
    <span class=p>)</span>
</code></pre></div> <p>In our <code>get_all_posts</code> function, we:</p> <ol> <li>query our db table associated with the <code>Post</code> model (i.e., the <code>post</code> table).</li> <li>We then JOIN <code>posts</code> with <code>user</code> using the <code>.join(User, Post.author_id == User.id)</code> param. Here, we basically 'paste' the columns of the <code>user</code> table "behind" the columns of the <code>post</code> table. To ensure that the values are associated with the correct record (i..e, author), you <em>tie</em> both data fields together by assigning the <code>Post.author_id</code> to <code>User.id</code>.</li> <li>Lastly, we fetch all posts in our database belonging to our user <code>admin_user</code>: we tell the db to only get the data where the <code>username</code> attribute in our <code>user</code> table equal the <code>admin_user.username</code> value (Bob-12 in our example).</li> </ol> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h2> <p><strong>General:</strong></p> <ul> <li><a href=https://hackersandslackers.com/python-database-management-sqlalchemy>Hackers &amp; Slackers</a></li> </ul> <p><strong>Data relationships in SQLAlchemy:</strong></p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2023-01-15T19:21:32+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-01-15</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../ class="md-footer__link md-footer__link--prev" aria-label="Previous: Python" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Python </div> </div> </a> <a href=../pydantic/ class="md-footer__link md-footer__link--next" aria-label="Next: Pydantic" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Pydantic </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.instant", "navigation.top", "content.code.annotate", "search.suggest", "search.highlight"], "search": "../../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.d6c3db9e.min.js></script> <script src=../../../../js/timeago.min.js></script> <script src=../../../../js/timeago_mkdocs_material.js></script> </body> </html>